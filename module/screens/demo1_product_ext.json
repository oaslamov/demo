{
  "code":"demo1_product_ext:scr@demo1_prvt",
  "label":"$l{Product (extended info)}l",
  "subject":"$l{Demo1}l/$l{Product}l",
  "sort_order":"Z20.2",
  "grid":{
    "base":"screen",
    "cols":240,
    "rows":240
  },
  "data_sources":[
    {
      "code":"ds_product",
      "table_name":"Demo1_Prvt.Product",
      "type":"table",
      "fields":[
        {
          "code":"id",
          "type":"string"
        },
        {
          "code":"name",
          "label":"$l{f:7ef07d007006}l",
          "type":"string",
          "hint":"$l{f:7ef07d007006:d}l"
        },
        {
          "code":"price",
          "label":"$l{f:7ef07d007009}l",
          "type":"number",
          "hint":"$l{f:7ef07d007009:d}l"
        },
        {
          "code":"product_type",
          "label":"$l{f:7ef07d007008}l",
          "type":"enum",
          "enum":[
            {
              "label":"$l{e:7ef07d007008.T}l",
              "value":"T"
            },
            {
              "label":"$l{e:7ef07d007008.B}l",
              "value":"B"
            },
            {
              "label":"$l{e:7ef07d007008.G}l",
              "value":"G"
            }
          ],
          "hint":"$l{f:7ef07d007008:d}l"
        },
        {
          "code":"url",
          "label":"$l{f:7ef07d00700a}l",
          "type":"string",
          "edit_condition":"false",
          "hint":"$l{f:7ef07d00700a:d}l"
        },
        {
          "code":"decor",
          "label":"$l{f:7ef07d00700b}l",
          "type":"decor",
          "hint":"$l{f:7ef07d00700b:d}l"
        },
        {
          "code":"shipping_from",
          "label":"$l{f:7ef07d00700c}l",
          "type":"id_list",
          "ref":{
            "data":{
              "action":"demo1_prvt.selectList",
              "args":{
                "filter":[
                  "${@ref_filter}"
                ],
                "tablename":"Demo1_Prvt.Country"
              },
              "fields":[
                "id",
                "@name"
              ]
            }
          },
          "hint":"$l{f:7ef07d00700c:d}l"
        }
      ],
      "operations":{
        "new":{
          "request":{
            "data":{
              "action":"demo1_prvt.new",
              "args":{
                "tablename":"demo1_prvt.product"
              }
            }
          }
        },
        "select":{
          "request":{
            "data":{
              "action":"demo1_prvt.selectList",
              "args":{
                "filter":[
                  "${@user_filter}",
                  "order by name"
                ],
                "tablename":"demo1_prvt.product"
              }
            }
          }
        },
        "insert":{
          "request":{
            "data":{
              "action":"demo1_prvt.insert",
              "args":{
                "tablename":"demo1_prvt.product",
                "fields":"${@all_fields}"
              }
            }
          }
        },
        "update":{
          "request":{
            "data":{
              "action":"demo1_prvt.update",
              "args":{
                "tablename":"demo1_prvt.product",
                "fields":"${@all_fields}"
              }
            }
          }
        },
        "delete":{
          "request":{
            "data":{
              "action":"demo1_prvt.deleteById",
              "args":{
                "id":"${id}",
                "tablename":"demo1_prvt.product"
              }
            }
          }
        }
      },
      "actions":[
        {
          "code":"openLink",
          "label":"$l{Open link}l",
          "request":{
            "data":{
              "action":"gui.goLink",
              "args":{
                "url":"${(-q)ds_product.url}"
              }
            }
          }
        }
      ]
    },
    {
      "code":"ds_att_file",
      "table_name":"Demo1_Prvt.Att_File",
      "type":"table",
      "fields":[
        {
          "code":"id",
          "type":"string"
        },
        {
          "code":"name",
          "label":"$l{File name}l",
          "type":"string",
          "hint":"$l{f:7ef07d021006:d}l"
        },
        {
          "code":"ref_code",
          "label":"$l{f:7ef07d021009}l",
          "type":"string",
          "hint":"$l{f:7ef07d021009:d}l"
        },
        {
          "code":"ref_id",
          "label":"$l{f:7ef07d021008}l",
          "type":"bigint",
          "hint":"$l{f:7ef07d021008:d}l"
        },
        {
          "code":"file_date",
          "label":"$l{f:7ef07d021007}l",
          "type":"datetime",
          "hint":"$l{f:7ef07d021007:d}l"
        }
      ],
      "operations":{
        "new":{
          "request":{
            "data":{
              "action":"demo1_prvt.new",
              "args":{
                "tablename":"demo1_prvt.att_file",
                "fields":{
                  "ref_id":"${ds_product.id}",
                  "ref_code":"product"
                }
              }
            }
          },
          "enable_condition":"${@e.is_product_selected}"
        },
        "select":{
          "request":{
            "data":{
              "action":"demo1_prvt.selectList",
              "args":{
                "filter":[
                  "ref_id=${ds_product.id} and ref_code='product'"
                ],
                "tablename":"demo1_prvt.att_file"
              }
            },
            "dependencies":[
              "ds_product.id"
            ]
          }
        },
        "insert":{
          "request":{
            "data":{
              "action":"demo1_prvt.insert",
              "args":{
                "tablename":"demo1_prvt.att_file",
                "fields":"${@all_fields}"
              }
            }
          },
          "enable_condition":"${@e.is_product_selected}"
        },
        "update":{
          "request":{
            "data":{
              "action":"demo1_prvt.update",
              "args":{
                "tablename":"demo1_prvt.att_file",
                "fields":"${@all_fields}"
              }
            }
          }
        },
        "delete":{
          "request":{
            "data":{
              "action":"demo1_prvt.deleteById",
              "args":{
                "id":"${id}",
                "tablename":"demo1_prvt.att_file"
              }
            }
          }
        }
      },
      "actions":[
        {
          "code":"upload",
          "label":"$l{Upload to this row}l",
          "type":"file_upload",
          "request":{
            "data":{
              "action":"common.upload",
              "args":{
                "filename":"${@name}",
                "dataTableName":"demo1_prvt.att_file_data",
                "data":"${@bytes}",
                "infoTableRowId":"${ds_att_file.id}",
                "fileTimeMillis":"${@filetime}"
              }
            }
          },
          "freshen":[
            {
              "type":"current_row"
            },
            {
              "code":"ds_doc_info",
              "type":"current_row"
            },
            {
              "code":"ds_att_file_data",
              "type":"all_rows"
            }
          ]
        },
        {
          "code":"download",
          "label":"$l{Download}l",
          "request":{
            "data":{
              "action":"common.download",
              "args":{
                "dataTableName":"demo1_prvt.att_file_data",
                "infoTableRowId":"${ds_att_file.id}"
              }
            }
          }
        },
        {
          "code":"uploadFile",
          "label":"$l{Upload to new row}l",
          "type":"file_upload",
          "data_scope":"none",
          "request":{
            "data":{
              "action":"demo1_prvt.uploadNewFile",
              "args":{
                "filename":"${@name}",
                "dataTableName":"demo1_prvt.att_file_data",
                "data":"${@bytes}",
                "fileTimeMillis":"${@filetime}",
                "infoFields":{
                  "ref_id":"${ds_product.id}",
                  "ref_code":"product"
                }
              }
            }
          },
          "freshen":[
            {
              "code":"ds_att_file",
              "type":"all_rows"
            }
          ],
          "enable_condition":"${@e.is_product_selected}"
        }
      ]
    },
    {
      "code":"ds_doc_info",
      "table_name":"Onlyoffice.Doc_Info",
      "type":"table",
      "fields":[
        {
          "code":"assigned_field",
          "label":"$l{f:68009007}l",
          "type":"string",
          "hint":"$l{f:68009007:d}l"
        },
        {
          "code":"configuration",
          "label":"$l{f:6800900b}l",
          "type":"text",
          "hint":"$l{f:6800900b:d}l"
        },
        {
          "code":"doc_row_id",
          "label":"$l{f:6800900e}l",
          "type":"string",
          "hint":"$l{f:6800900e:d}l"
        },
        {
          "code":"id",
          "type":"string"
        },
        {
          "code":"is_can_edit",
          "label":"$l{f:68009009}l",
          "type":"bool",
          "hint":"$l{f:68009009:d}l"
        },
        {
          "code":"is_supported_file_type",
          "label":"$l{f:6800900a}l",
          "type":"bool",
          "hint":"$l{f:6800900a:d}l"
        },
        {
          "code":"key",
          "label":"$l{f:68009010}l",
          "type":"string",
          "hint":"$l{f:68009010:d}l"
        },
        {
          "code":"message",
          "label":"$l{f:6800900d}l",
          "type":"text",
          "hint":"$l{f:6800900d:d}l"
        },
        {
          "code":"module",
          "label":"$l{f:68009008}l",
          "type":"string",
          "hint":"$l{f:68009008:d}l"
        },
        {
          "code":"title",
          "label":"$l{f:6800900f}l",
          "type":"string",
          "hint":"$l{f:6800900f:d}l"
        }
      ],
      "operations":{
        "select":{
          "request":{
            "data":{
              "action":"onlyoffice.selectList",
              "args":{
                "filter":[
                  "doc_row_id=${ds_att_file.id} and assigned_field='demo1_prvt.att_file_data.data'"
                ],
                "tablename":"onlyoffice.doc_info"
              }
            },
            "dependencies":[
              "ds_att_file.id"
            ]
          }
        }
      },
      "actions":[
        {
          "code":"editDocument",
          "label":"$l{Edit document}l",
          "request":{
            "data":{
              "action":"gui.editDocument"
            }
          }
        }
      ]
    },
    {
      "code":"ds_att_file_data",
      "table_name":"Demo1_Prvt.Att_File_Data",
      "type":"table",
      "fields":[
        {
          "code":"att_file",
          "label":"$l{f:7ef07d022006}l",
          "type":"ref",
          "ref":{
            "data":{
              "action":"demo1_prvt.selectList",
              "args":{
                "filter":[
                  "${@ref_filter}"
                ],
                "tablename":"Demo1_Prvt.Att_File"
              },
              "fields":[
                "id",
                "@name"
              ]
            }
          },
          "hint":"$l{f:7ef07d022006:d}l"
        },
        {
          "code":"data",
          "label":"$l{f:7ef07d022008}l",
          "type":"bytes",
          "hint":"$l{f:7ef07d022008:d}l"
        },
        {
          "code":"id",
          "type":"string"
        }
      ],
      "operations":{
        "select":{
          "request":{
            "data":{
              "action":"demo1_prvt.selectList",
              "args":{
                "filter":[
                  "${ds_att_file.id}=Att_File"
                ],
                "tablename":"demo1_prvt.att_file_data"
              }
            },
            "dependencies":[
              "ds_att_file.id"
            ]
          }
        }
      }
    }
  ],
  "expressions":[
    {
      "code":"is_product_selected",
      "text":"${ds_product.id}!=null"
    }
  ],
  "parts":[
    {
      "code":"p_main",
      "type":"table",
      "border_type":"none",
      "position":{
        "from_col":1,
        "to_col":100,
        "from_row":1,
        "to_row":120
      },
      "data_source":{
        "code":"ds_product",
        "fields":[
          {
            "code":"decor"
          },
          {
            "code":"name",
            "width":"30%"
          },
          {
            "code":"price",
            "width":"10%"
          },
          {
            "code":"product_type",
            "width":"10%"
          }
        ],
        "order":[
          {
            "field":"name"
          }
        ],
        "operations":[
          "new",
          "select",
          "insert",
          "update",
          "delete"
        ],
        "actions":[
          "openLink"
        ]
      }
    },
    {
      "code":"p_att",
      "type":"table",
      "border_type":"none",
      "position":{
        "from_col":1,
        "to_col":100,
        "from_row":161,
        "to_row":240
      },
      "data_source":{
        "code":"ds_att_file",
        "fields":[
          {
            "code":"name"
          },
          {
            "code":"file_date"
          }
        ],
        "operations":[
          "new",
          "select",
          "insert",
          "update",
          "delete"
        ],
        "actions":[
          "upload",
          "download",
          "uploadFile"
        ]
      }
    },
    {
      "code":"p_doc_form",
      "label":"$l{Document}l: ${ds_doc_info.title}",
      "type":"form",
      "border_type":"none",
      "position":{
        "from_col":101,
        "to_col":240,
        "from_row":1,
        "to_row":240
      },
      "data_source":{
        "code":"ds_doc_info",
        "operations":[
          "select"
        ],
        "actions":[
          "editDocument"
        ]
      },
      "view_condition":"${ds_doc_info.is_supported_file_type}"
    },
    {
      "code":"p_img_form",
      "type":"form",
      "border_type":"none",
      "position":{
        "from_col":101,
        "to_col":240,
        "from_row":1,
        "to_row":240
      },
      "data_source":{
        "code":"ds_att_file_data",
        "fields":[
          {
            "code":"att_file"
          },
          {
            "code":"data"
          }
        ],
        "operations":[
          "select"
        ],
        "row_template":"<header>\n<img style=\"object-fit:scale-down; height: 100%; width: 100%; padding: 1em;\" src=\"data:image/${img_frmt};base64,${img}\" onerror=\"this.style.display='none'\">\n</header>\n<script>\nds.getRows().forEach( row=> {\ndata.img=row.data\ndata.img_frmt=row[\"att_file:name\"].split('.').pop()\n})\n</script>"
      },
      "view_condition":"!${ds_doc_info.is_supported_file_type}"
    },
    {
      "code":"p_shipping_from",
      "type":"form",
      "border_type":"none",
      "position":{
        "from_col":1,
        "to_col":100,
        "from_row":121,
        "to_row":160
      },
      "data_source":{
        "code":"ds_product",
        "fields":[
          {
            "code":"shipping_from"
          }
        ],
        "operations":[
          "select",
          "update"
        ]
      }
    }
  ]
}