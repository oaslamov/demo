<!DOCTYPE HTML>
<html>
 <head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title></title>
  <link rel="stylesheet" type="text/css" href="../common/dolmendoc.css">
  <link rel="shortcut icon" type="image/*" href="../common/dolmen32.png"/>
  
 </head>
 <body>
<div class="nav">
<div id="mySidenav" class="sidenav">
<ul class="c_ul">

<li><a href="DolmenProdInstall.html">DolmenProdInstall</a></li>
</ul></div>
<script>
var toggler = document.getElementsByClassName("c_clo");
var i;

for (i = 0; i < toggler.length; i++) {
  ind_tog(toggler[i], true)
}

function ind_tog(el, isinit){
  var did;
  var ul_e;
  var ison;
  ul_e=el.parentElement.querySelector(".c_subt");
  did=ul_e.id;
  if(isinit){
    ison=localStorage.getItem("op"+did)
    if(ison==1)ison=false
    else ison=true
  }else ison=ul_e.classList.contains("c_op");
  if(ison){
    ul_e.classList.remove("c_op");
    el.classList.remove("c_clo-down");
    if(!isinit)localStorage.removeItem("op"+did)
  }else{
    ul_e.className+=" c_op"
    el.className+=" c_clo-down"
    if(!isinit)localStorage.setItem("op"+did,"1")
  }
}

for (i = 0; i < toggler.length; i++) {
  toggler[i].addEventListener("click", function() {
    ind_tog(this, false)
  });
}
</script>
</div>
<div id="main">
<div class="sw-cont" style="position: absolute; right:1em">
<input type="checkbox" id="chth" class="chsel" />
<label for="chth"></label>
<script>
const sw = document.querySelector('.sw-cont input[type="checkbox"]');
function swTheme(e) {
    if (e.target.checked) {
        document.documentElement.setAttribute('data-theme', 'dark');
        localStorage.setItem('dlm-theme-doc', 'dark');
    } else {
        document.documentElement.setAttribute('data-theme', 'light');
        localStorage.setItem('dlm-theme-doc', 'light');
    }    
}
sw.addEventListener('change', swTheme, false);
const currTheme = localStorage.getItem('dlm-theme-doc')
if (currTheme) {
    document.documentElement.setAttribute('data-theme', currTheme);
    sw.checked = currTheme === 'dark';
}
</script>
</div>

<p>% Пример установки production среды Дольмен</p>
<h2 id="общиесведения">Общие сведения</h2>
<p>В этом примере устанавливаем <em>Dolmen Application Server</em> и <em>Dolmen Web Server</em> на один сервер, а <em>PostgreSQL</em> на другой. Будет настроен доступ по <em>https</em> и аутентификация пользователей через <em>Active Directory.</em></p>
<h3 id="сервернаяоперационнаясистема">Серверная операционная система</h3>
<p><em>Windows Server 2019</em></p>
<h3 id="urlвебинтерфейса">URL веб-интерфейса</h3>
<p><a href="https://dolmensystem.corp.example.com/dolmensite" class="ba">https://dolmensystem.corp.example.com/dolmensite</a></p>
<h3 id="dnsимена">DNS имена</h3>
<table>
<thead>
<tr><th>Описание</th><th>DNS имя</th><th>IP</th></tr>
</thead>
<tbody>
<tr><td>FQDN имя домена Active Directory</td><td>corp.example.com</td></tr>
<tr><td>сервер PostgreSQL</td><td>dlm-db.corp.example.com</td><td>10.23.45.12</td></tr>
<tr><td>сервер Дольмен</td><td>dlm01.corp.example.com</td><td>10.23.45.11</td></tr>
<tr><td>имя для доступа через браузер</td><td>dolmensystem.corp.example.com</td><td>10.23.45.11</td></tr>
</tbody>
</table>
<h3 id="пароли">Пароли</h3>
<table>
<thead>
<tr><th>Описание</th><th>Логин, пароль</th></tr>
</thead>
<tbody>
<tr><td>Администратор сервера Дольмен</td><td>admin : P@$$w0rd</td></tr>
<tr><td>Суперпользователь PostgreSQL</td><td>postgres : pgPw0rd</td></tr>
<tr><td>Пользователь сервера Дольмен в PostgreSQL</td><td>dlm_pguser : hT4BhLYK</td></tr>
<tr><td>Закрытый ключ в файле .pfx</td><td>Pass1234</td></tr>
<tr><td>Учетная запись сервера Дольмен для реализации SSO</td><td>CORP\dolmensrv_user : lDtGF4Ypk56#</td></tr>
<tr><td>Учетная запись для запуска сервиса</td><td>CORP\dolmensrv_user : lDtGF4Ypk56# или CORP\dolmensrv_gmsa, или localservice</td></tr>
</tbody>
</table>
<h2 id="установкаинастройкаpostgresql">Установка и настройка PostgreSQL</h2>
<p>Команда для автоматической установки сервера <em>PostgreSQL</em></p>
<pre><code>postgresql-11.10-1-windows-x64.exe --mode unattended --superpassword pgPw0rd
</code></pre>
<p>Если сервер СУБД установлен не на том же сервере, где сервер Дольмен, то разрешить доступ c IP адреса 10.23.45.11 на файрволле</p>
<pre><code>netsh advfirewall firewall add rule name=&quot;postgres5432&quot; dir=in action=allow protocol=TCP localport=5432 remoteip=10.23.45.11
</code></pre>
<p>и в файле <code>C:\Program Files\PostgreSQL\11\data\pg_hba.conf</code></p>
<pre><code>host	all				all				10.23.45.11/32			md5
</code></pre>
<p>Создать пользователя для сервера Дольмен и схему</p>
<pre><code>set PGPASSWORD=pgPw0rd
&quot;c:\Program Files\PostgreSQL\11\bin\psql.exe&quot; -U postgres -w
create user dlm_pguser with password 'hT4BhLYK';
create schema dlmprod authorization dlm_pguser;
\q
set PGPASSWORD=
</code></pre>
<h2 id="установкаdolmenhome">Установка DolmenHome</h2>
<p>Файлы дистрибутива</p>
<ul>
<li><em><span xxxx="">dlm.server.</span>.zip</em></li>
<li><em><span xxxx="">dlm.gui.</span>.zip</em></li>
<li><em><span xxxx="">dlm.appserv-tomcat</span>.zip</em></li>
<li><em><span xxxx="">dlm.jdk.</span>.zip</em></li>
<li><em><span xxxx="">dlm.doc.</span>.zip</em></li>
</ul>
<p>разархивировать в папку <code>c:\dolmen\DolmenHome</code></p>
<p>Должна получиться следующая структура папок</p>
<pre><code>c:\dolmen
  DolmenHome
    doc
    rt
    site
    templates
    thirdparty
</code></pre>
<h2 id="установкаworkspace">Установка Workspace</h2>
<p>Создать <em>workspace</em> типа <em>prod</em> и установить пароль администратора</p>
<pre><code>c:\dolmen\DolmenHome\rt\dolmen.bat c:\dolmen\Workspace bundle-install prod
c:\dolmen\Workspace\configure.bat set-password dolmen P@$$w0rd
</code></pre>
<h2 id="доступксубд">Доступ к СУБД</h2>
<p>Отредактировать файл <code>c:\dolmen\Workspace\webserver\webapps\dolmen\secure_store.dat</code></p>
<pre><code>&quot;keys&quot;:{
    &quot;db_dolmen&quot;:&quot;hT4BhLYK&quot;
},
</code></pre>
<p>Отредактировать файл <code>c:\dolmen\Workspace\webserver\webapps\dolmen\server.conf</code>. Если PostgreSQL на том же сервере, то вместо <em>dlm-db.corp.example.com</em> оставить <em>127.0.0.1</em></p>
<pre><code>&quot;database&quot;:{
	&quot;url&quot;: &quot;dlm_pguser/$(SS:db_dolmen)@jdbc:postgresql://dlm-db.corp.example.com:5432/postgres&quot;,
	&quot;schema&quot;: &quot;dlmprod&quot;,
</code></pre>
<h2 id="trustedhosts">Trusted Hosts</h2>
<p>Отредактировать файл <code>c:\dolmen\Workspace\webserver\webapps\dolmen\server.conf</code></p>
<pre><code>&quot;trustedHosts&quot;:[
	&quot;dolmensystem.corp.example.com&quot;
],
</code></pre>
<h2 id="настройкаsso">Настройка SSO</h2>
<p>Настроить SSO в <code>c:\dolmen\Workspace\webserver\webapps\dolmen\server.conf</code></p>
<pre><code>&quot;sso&quot;:{
	&quot;spn&quot;: &quot;HTTP/dolmensystem.corp.example.com@CORP.EXAMPLE.COM&quot;,
	&quot;realm&quot;: &quot;CORP.EXAMPLE.COM&quot;,
	&quot;ktabFile&quot;: &quot;C:/dolmen/Workspace/webserver/webapps/dolmen/dolmen.ktab&quot;
},
</code></pre>
<p>На контроллере домена создать пользователя в AD и настроить  SPN</p>
<pre><code>dsadd user &quot;CN=dolmensrv_user,CN=Users,DC=corp,DC=example,DC=com&quot; –pwd lDtGF4Ypk56# -pwdneverexpires yes -canchpwd no -fn dolmensrv_user
setspn -U -S HTTP/dolmensystem.corp.example.com dolmensrv_user
</code></pre>
<p>На сервере Дольмен создать ktab файл</p>
<pre><code>c:\dolmen\DolmenHome\rt\java\jdk\bin\ktab.exe -k FILE:C:\dolmen\Workspace\webserver\webapps\dolmen\dolmen.ktab -a HTTP/dolmensystem.corp.example.com@CORP.EXAMPLE.COM lDtGF4Ypk56#
</code></pre>
<h2 id="настройкаhttps">Настройка <em>https</em></h2>
<h3 id="настройкисерверадольмендляработыпоhttps">Настройки сервера Дольмен для работы по <em>https</em></h3>
<p>Выпустить сертификат и закрытый ключ для веб-сервера, <em>cn=dlm01.corp.example.com, san=dlm01.corp.example.com, san=dolmensystem.corp.example.com</em></p>
<p>Экспортировать сертификат и закрытый ключ в файл <code>c:\dolmen\Workspace\webserver\webapps\dolmen\dolmensystem.pfx</code></p>
<p>Узнать alias закрытого ключа в файле <code>c:\dolmen\Workspace\webserver\webapps\dolmen\dolmensystem.pfx</code> (при помощи <em>keytool</em> или <a href="https://keystore-explorer.org/" class="ba">KeyStore Explorer</a>)</p>
<pre><code>c:\dolmen\DolmenHome\rt\java\jdk\bin\keytool -list -keystore c:\dolmen\Workspace\webserver\webapps\dolmen\dolmensystem.pfx -storepass Pass1234
</code></pre>
<p>Отредактировать <code>C:\dolmen\Workspace\server.properties</code>, установить <em>https=&ldquo;true&rdquo;</em> и настроить доступ к хранилищу ключей (<em>httpsKeyAlias</em> взять из предыдущего шага)</p>
<pre><code>https=&quot;true&quot;
httpsKeyAlias=&quot;te-webserver-7f670036-e593-4381-b9bc-1c599b6eca7c&quot;
httpsKSFile=&quot;C:\dolmen\Workspace\webserver\webapps\dolmen\dolmensystem.pfx&quot;
httpsKSPass=&quot;Pass1234&quot;
</code></pre>
<p>Настроить доступ к серверу Дольмен по <em>https</em> и отключить доступ по <em>http</em></p>
<pre><code>C:\dolmen\Workspace\configure.bat serv-url dolmensite https://dolmensystem.corp.example.com/dolmen
C:\dolmen\Workspace\configure.bat httpsonly dolmen true
C:\dolmen\Workspace\configure.bat httpsonly dolmensite true
C:\dolmen\Workspace\update.bat
</code></pre>
<h3 id="настройкафайрволла">Настройка файрволла</h3>
<p>Открыть порт <em>TCP 443</em></p>
<pre><code>netsh advfirewall firewall add rule name=&quot;dolmen443&quot; dir=in action=allow protocol=TCP localport=443
</code></pre>
<h3 id="настройкибраузера">Настройки браузера</h3>
<p>Обеспечить наличие сертификата удостоверяющего центра, который выдал сертификат сервера, на пользовательских компьютерах</p>
<p>Добавить <em>https://dolmensystem.corp.example.com</em> в <em>local intranet</em></p>
<ul>
<li>Панель управления: <em>Internet Options - Local intranet - Sites - Advanced</em></li>
<li>Или групповые политики: <em>User Configuration/Policies/Administrative Templates/Windows Components/Internet Explorer/Internet Control Panel/Security Page/Site to Zone Assignment List</em> - установить <em>Enabled</em> и добавить <em>value name = https://dolmensystem.corp.example.com, value = 1</em></li>
</ul>
<h2 id="настройказапускасерверадольменкаксервисаwindows">Настройка запуска сервера Дольмен как сервиса Windows</h2>
<p>Запустить <em>webserver_instance.bat</em> c аргументами <em>service install.</em> Будет установлен сервис <em>Dolmen-1</em> (Display name <em>Apache Tomcat 8.5 Dolmen-1)</em> для запуска под <em>Local system account</em></p>
<pre><code>c:\dolmen\Workspace\webserver_instance.bat service install
</code></pre>
<p>При необходимости можно изменить учетную запись для сервиса.</p>
<p>Например,</p>
<ul>
<li>
<p>для запуска под <em>Local Service</em></p>
<pre><code>sc config Dolmen-1 obj= &quot;NT AUTHORITY\LocalService&quot; password= &quot;&quot; 
</code></pre>
</li>
<li>
<p>под доменной учетной записью <em>dolmensrv_user</em></p>
<pre><code>sc config Dolmen-1 obj= &quot;CORP\dolmensrv_user&quot; password= &quot;lDtGF4Ypk56#&quot; 
</code></pre>
</li>
<li>
<p>под доменной gMSA  <em>dolmensrv_gmsa</em></p>
<pre><code>sc config Dolmen-1 obj= &quot;CORP\dolmensrv_gmsa$&quot; password= &quot;&quot; 
</code></pre>
</li>
</ul>
<h2 id="разрешениянаcdolmen">Разрешения на <code>c:\dolmen</code></h2>
<p>У папки <code>c:\dolmen</code> и ее подпапок и файлов убрать разрешения для <em>Domain Users</em>. Назначить разрешения <em>Full Control</em> для администраторов сервера, администраторов приложения Дольмен и для учетной записи, под которой запускается сервис <em>Dolmen-1.</em></p>
<h2 id="запусксервераиустановкамодулей">Запуск сервера и установка модулей</h2>
<ul>
<li>
<p>Запустить сервис</p>
<pre><code>sc start Dolmen-1
</code></pre>
</li>
<li>Открыть в Chrome    <a href="https://dolmensystem.corp.example.com/dolmensite" class="ba">https://dolmensystem.corp.example.com/dolmensite</a></li>
<li>Войти, используя имя пользователя   <em>admin</em>  и пароль <em>P@$$w0rd</em></li>
<li>Установить модули и зарегистрировать сервер в базе данных
<ul>
<li>Перейти на экран  <em>Обслуживание -&gt; Администрирование -&gt; Сервер и модули -&gt; Сервер (управление)</em></li>
<li>Нажать <em>Установить все модули</em></li>
<li>Нажать <em>Зарегистрировать</em></li>
<li>Обновить страницу браузера</li>
<li>В поле <em>Запрос состояния</em> выбрать <em>Запущен</em></li>
<li>Обновить страницу браузера</li>
</ul>
</li>
</ul>

<script>

    var a = document.getElementsByTagName("A");
    for(var i=0;i<a.length;i++)
        if(a[i].href == window.location.href.split("#")[0])
            a[i].className='cur'
</script>
</div></body></html>